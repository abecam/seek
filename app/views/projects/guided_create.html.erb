<%

  #states
  show_programme_box = Seek::Config.programmes_enabled && ( programme_administrator_logged_in? || Programme.site_managed_programme.present? || Seek::Config.programme_user_creation_enabled )
  programme_dropdown = programme_administrator_logged_in?
  managed_checkbox = !programme_dropdown && Programme.site_managed_programme.present? && Seek::Config.programme_user_creation_enabled
  managed_only = !programme_dropdown && Programme.site_managed_programme.present? && !Seek::Config.programme_user_creation_enabled
  creation_allowed = Seek::Config.programme_user_creation_enabled
  creation_allowed_only = creation_allowed && !(programme_administrator_logged_in? || Programme.site_managed_programme.present?)

%>

<%= form_tag request_create_projects_path do %>
  <div class="row">
    <div  style="margin:auto;width:70%;">

      <% if show_programme_box %>
        <div class="panel panel-default">
          <div class="panel-heading"><%= t('programme') %></div>
          <div class="panel-body">

            <% if programme_dropdown %>

              <div class="help-block">
                Select the <%= t('programme') %> you wish to associate the new <%= t('project') %> with, out of the following list that you administer.
              </div>
              <% if !admin_logged_in? && Programme.site_managed_programme.present? %>
                <div class="help-block">
                  You can also choose the <%= "#{Seek::Config.dm_project_name} managed #{t('programme')}" %>, <%= link_to Programme.site_managed_programme.title, Programme.site_managed_programme %>, and if so you will need to wait for approval.
                </div>
              <% end %>
              <% programmes = (User.current_user.person.administered_programmes + [Programme.site_managed_programme]).compact.uniq %>
              <%= select_tag :programme_id,options_from_collection_for_select(programmes,:id, :title), class: 'form-control' %>
              <% if creation_allowed %>
                <div class="help-block">
                  Alternatively you can choose to create a new <%= t('programme') %>, which after approval your new <%= t('project') %> will be associated with.
                </div>
                <label>
                  <%= check_box_tag :new_programme, '1', false %>
                  <%= "Request a new #{t('programme')}?" %>
                </label>
              <% end %>

            <% elsif managed_checkbox %>

              <%= hidden_field_tag :programme_id, Programme.site_managed_programme.id %>
              <div class="help-block">
                You can choose either to be linked to a <%= "#{Seek::Config.dm_project_name} managed #{t('programme')}" %>, <%= link_to Programme.site_managed_programme.title, Programme.site_managed_programme %>, or have one created for you.
              </div>
              <div class="help-block">
                If you have a <%= t('programme') %> created, then you will then be able to freely create further <%= t('project').pluralize %> within
                it. To have one created, then please provide the name. You will be able to provide additional details, if you wish, once it has been created.
              </div>
              <label>
                <%= check_box_tag :managed_programme, '1', true %>
                <%= "#{Seek::Config.dm_project_name} managed #{t('programme')}?" %>
              </label>

            <% elsif managed_only %>

              <%= hidden_field_tag :programme_id, Programme.site_managed_programme.id %>
              <div class="help-block">
                Your new <%= t('project') %> will be linked to the <%= "#{Seek::Config.dm_project_name} managed #{t('programme')}" %>, <%= link_to Programme.site_managed_programme.title, Programme.site_managed_programme %>.
              </div>

            <% end %>


            <% if creation_allowed %>
              <% if creation_allowed_only %>
                <div id='programme-details'>
              <% else %>
                <div id='programme-details' style="display:none;">
              <% end %>
                <%= label_tag :programme_title, "Title" %><span class="required">*</span>
                <%= text_field_tag 'programme[title]', '', class: 'form-control' %>
              </div>
            <% end %>

          </div>
        </div>
      <% end %>

      <div class="panel panel-default">
        <div class="panel-heading"><%= t('project') %></div>
        <div class="panel-body">
          <div class="help-block">
            Please provide some basic details about the <%= t('project') %> that will be created. You will be able to update and add additional
            information once it has been created.
          </div>

          <%= label_tag :project_title, "Title" %><span class="required">*</span>
          <%= text_field_tag 'project[title]', '', class: 'form-control' %>
          <%= label_tag :project_title, "Description" %>
          <%= text_area_tag 'project[description]', '', rows:2, class: 'form-control' %>
          <%= label_tag :project_title, "Web page" %>
          <%= text_field_tag 'project[web_page]', '', class: 'form-control' %>

        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading"><%= t('institution') %></div>
        <div class="panel-body">

          <div class="form-group">
            <%= render partial: 'institutions/select_or_define' %>
          </div>

        </div>
      </div>

      <%= submit_tag('Submit', class: 'btn btn-primary',id:'submit-button',disabled:true) %>
    </div>
  </div>
<% end %>


<script type=application/javascript>

    function checkSubmitButtonEnabled() {
        var progEnabled = <%= Seek::Config.programmes_enabled %>;
        var enabled = $j('#institution_id').val()
            && !progEnabled || ($j('#programme_id').val() || $j('input#programme_title').val())
            && $j('input#project_title').val()
            && $j('select#institution_country').val();
        $j('#submit-button').prop('disabled',!enabled);
    }

    $j(document).ready(function () {
        $j('form').on('submit',function() {
            //clear the id if -1 before submitting
            if ($j('#institution_id').val()=='-1') {
                $j('#institution_id').val('');
            }
        });

       <% if managed_checkbox %>
         $j('input#managed_programme').on('change', function() {
             if ($j('input#managed_programme:checked').length == 0) {
                 $j('#programme-details').show();
                 $j('#programme_id').val('');
             }
             else {
                 $j('#programme_id').val('<%= Programme.site_managed_programme.id %>');
                 $j('#programme-details').hide();
                 $j('input#programme_title').val('');
             }
             checkSubmitButtonEnabled();
         });
       <% end %>

       <% if creation_allowed && programme_dropdown %>
        $j('input#new_programme').on('change', function() {
            if ($j('input#new_programme:checked').length == 1) {
                $j('#programme-details').show();
                $j('select#programme_id').prop('disabled',true);
                $j('select#programme_id').attr('name','disabled-programme_id');
                $j('select#programme_id').attr('id','disabled-programme_id');
            }
            else {
                $j('#programme-details').hide();
                $j('input#programme_title').val('');
                $j('select#disabled-programme_id').attr('name','programme_id');
                $j('select#disabled-programme_id').attr('id','programme_id');
                $j('select#programme_id').prop('disabled',false);
            }
            checkSubmitButtonEnabled();
        });
       <% end %>

       $j('input#programme_title').on('input',function() {
          checkSubmitButtonEnabled();
       });

        $j('input#project_title').on('input',function() {
            checkSubmitButtonEnabled();
        });
    });
</script>